{% extends "base.html" %}

{% block title %}{{ guild.name }} - Locutus{% endblock %}

{% block extra_head %}
<style>
    .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e5e7eb;
    }
    .tab {
        padding: 10px 20px;
        cursor: pointer;
        border: none;
        background: none;
        color: #6b7280;
        font-size: 16px;
        transition: all 0.3s;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
    }
    .tab:hover {
        color: #3b82f6;
    }
    .tab.active {
        color: #1e3a8a;
        border-bottom-color: #3b82f6;
        font-weight: 600;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .schedule-item {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    .schedule-item h4 {
        color: #1f2937;
        margin-bottom: 10px;
    }
    .schedule-meta {
        color: #6b7280;
        font-size: 14px;
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }
</style>
{% endblock %}

{% block content %}
<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px;">
    {% if guild.icon %}
        <img src="https://cdn.discordapp.com/icons/{{ guild.id }}/{{ guild.icon }}.png?size=64" 
             alt="{{ guild.name }}" 
             style="width: 64px; height: 64px; border-radius: 50%;">
    {% else %}
        <div style="width: 64px; height: 64px; border-radius: 50%; background: #3b82f6; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
            {{ guild.name[0] }}
        </div>
    {% endif %}
    <div>
        <h2 style="color: #1e3a8a;">{{ guild.name }}</h2>
        <p style="color: #6b7280;">Guild ID: {{ guild.id }}</p>
    </div>
</div>

<div class="tabs">
    <button class="tab active" onclick="showTab('schedules')">Schedules</button>
    <button class="tab" onclick="showTab('wizard')">Create Reminder</button>
    <button class="tab" onclick="showTab('config')">Configuration</button>
    <button class="tab" onclick="showTab('templates')">Templates</button>
</div>

<div id="schedules" class="tab-content active">
    <h3 style="color: #1e3a8a; margin-bottom: 20px;">Active Schedules</h3>
    {% if schedules %}
        {% for schedule in schedules %}
        <div class="schedule-item">
            <h4>{{ schedule.system_name }}</h4>
            <div class="schedule-meta">
                <span><strong>Day:</strong> {{ ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'][schedule.weekday] }}</span>
                <span><strong>Time:</strong> {{ schedule.time_local }} ({{ schedule.timezone }})</span>
                <span><strong>Next Run:</strong> {{ schedule.next_run_utc.strftime('%Y-%m-%d %H:%M UTC') }}</span>
                {% if schedule.advance_minutes > 0 %}
                <span><strong>Advance:</strong> {{ schedule.advance_minutes }} minutes before</span>
                {% endif %}
            </div>
            <div style="margin-top: 10px;">
                <button class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;">Edit</button>
                <button class="btn btn-danger" style="font-size: 12px; padding: 5px 10px;" onclick="deleteSchedule('{{ schedule.id }}')">Delete</button>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-info">
            No schedules configured yet. Use the "Create Reminder" tab to set up your first territory defense reminder.
        </div>
    {% endif %}
</div>

<div id="wizard" class="tab-content">
    <h3 style="color: #1e3a8a; margin-bottom: 20px;">Create Territory Defense Reminder</h3>
    <form method="POST" action="/guild/{{ guild.id }}/schedule/create">
        <div class="form-group">
            <label>Step 1: Choose Template</label>
            <select name="template_id" required>
                <option value="">Select a template...</option>
                {% for template in templates %}
                <option value="{{ template.id }}" {% if template.is_default %}selected{% endif %}>{{ template.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label>Step 2: System Name</label>
            <input type="text" name="system_name" placeholder="e.g., Sol System" required>
        </div>
        
        <div class="form-group">
            <label>Step 3: Choose Weekday</label>
            <select name="weekday" required>
                <option value="0">Monday</option>
                <option value="1">Tuesday</option>
                <option value="2">Wednesday</option>
                <option value="3">Thursday</option>
                <option value="4">Friday</option>
                <option value="5">Saturday</option>
                <option value="6">Sunday</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Step 4: Choose Time (24-hour format HH:MM)</label>
            <input type="time" name="time_local" required>
        </div>
        
        <div class="form-group">
            <label>Advance Notice (minutes before scheduled time)</label>
            <input type="number" name="advance_minutes" value="0" min="0" max="1440" placeholder="0">
            <small style="color: #6b7280; display: block; margin-top: 5px;">
                Set to 10 to send the reminder 10 minutes before the scheduled time. Leave at 0 for exact time.
            </small>
        </div>
        
        <div class="form-group">
            <label>Channel (optional - uses guild default if not specified)</label>
            <input type="text" name="channel_id" placeholder="Channel ID">
        </div>
        
        <button type="submit" class="btn btn-primary">Create Reminder</button>
    </form>
</div>

<div id="config" class="tab-content">
    <h3 style="color: #1e3a8a; margin-bottom: 20px;">Guild Configuration</h3>
    <form method="POST" action="/guild/{{ guild.id }}/config/update">
        <div class="form-group">
            <label>Default Role ID for Mentions</label>
            <input type="text" name="role_id" value="{{ guild_config.role_id or '' }}" placeholder="Role ID (numeric)">
            <small style="color: #6b7280; display: block; margin-top: 5px;">
                This role will be mentioned in reminders using &lt;@&amp;ROLE_ID&gt; format.
            </small>
        </div>
        
        <div class="form-group">
            <label>Default Timezone (IANA format)</label>
            <input type="text" name="timezone" value="{{ guild_config.timezone }}" placeholder="e.g., Europe/Berlin" required>
            <small style="color: #6b7280; display: block; margin-top: 5px;">
                Use IANA timezone names like America/New_York, Europe/London, Asia/Tokyo
            </small>
        </div>
        
        <div class="form-group">
            <label>Default Channel ID</label>
            <input type="text" name="default_channel_id" value="{{ guild_config.default_channel_id or '' }}" placeholder="Channel ID">
            <small style="color: #6b7280; display: block; margin-top: 5px;">
                Default channel for announcements if not specified per schedule.
            </small>
        </div>
        
        <button type="submit" class="btn btn-primary">Save Configuration</button>
    </form>
</div>

<div id="templates" class="tab-content">
    <h3 style="color: #1e3a8a; margin-bottom: 20px;">Message Templates</h3>
    
    {% if templates %}
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Default</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for template in templates %}
                <tr>
                    <td>{{ template.name }}</td>
                    <td>{% if template.is_default %}✓{% endif %}</td>
                    <td>
                        <button class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;">Edit</button>
                        <button class="btn btn-danger" style="font-size: 12px; padding: 5px 10px;">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="alert alert-info">
            No custom templates yet. Default templates will be loaded automatically.
        </div>
    {% endif %}
    
    <h4 style="color: #1e3a8a; margin-top: 30px; margin-bottom: 15px;">Create New Template</h4>
    <form method="POST" action="/guild/{{ guild.id }}/template/create">
        <div class="form-group">
            <label>Template Name</label>
            <input type="text" name="name" placeholder="e.g., Default English Template" required>
        </div>
        
        <div class="form-group">
            <label>Template Content</label>
            <textarea name="content" placeholder="Use {system_name} and {role_id} as placeholders" required></textarea>
            <small style="color: #6b7280; display: block; margin-top: 5px;">
                Available placeholders: {system_name}, {role_id}
            </small>
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" name="is_default" value="1">
                Set as default template
            </label>
        </div>
        
        <button type="submit" class="btn btn-primary">Create Template</button>
    </form>
</div>

<div style="margin-top: 30px;">
    <a href="/guilds" class="btn btn-secondary">← Back to Guilds</a>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function showTab(tabName) {
    // Hide all tab contents
    const contents = document.querySelectorAll('.tab-content');
    contents.forEach(content => content.classList.remove('active'));
    
    // Remove active class from all tabs
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => tab.classList.remove('active'));
    
    // Show selected tab content
    document.getElementById(tabName).classList.add('active');
    
    // Add active class to clicked tab
    event.target.classList.add('active');
}

function deleteSchedule(scheduleId) {
    if (confirm('Are you sure you want to delete this schedule?')) {
        fetch(`/guild/{{ guild.id }}/schedule/${scheduleId}/delete`, {
            method: 'POST',
        }).then(() => {
            location.reload();
        });
    }
}
</script>
{% endblock %}
